## JWT

### 세줄 요약

- JSON 객체를 사용하여 가볍고 안정적으로 정보를 전달해주는 방식이다.
- 토큰에 대한 기본 정보, 유저 정보, 토큰이 검증됐다는 것을 증명하는 서명을 포함하고 있다.
- 유저가 서버에 요청할 때 JWT를 포함하며 전달하면 서버는 그 토큰을 검증하고 권한을 처리한다.
<br/>
 
### 장점

- 접속 정보 세션을 유지할 필요 없다.
- 쿠키를 전달하지 않아도 되므로 쿠키로 인한 취약점이 사라진다.
- 요청받은 토큰만 검증하면 되므로 추가적인 인증을 위한 DB I/O 불필요하다.
- 트래픽 부담이 낮다.
<br/>
 
### 단점

- 토큰 자체에 모든 정보를 담고 있으므로 보안 이슈가 있으며 정보가 많아질 수록 토큰 길이가 늘어나 네트워크에 부하를 줄 수 있다.
- 한 번 만들어지면 삭제가 불가능하여 토큰 만료 시간을 꼭 넣어주어야 한다.
<br/>
 
### 인증 방식으로 JWT 를 사용해야 하는 이유

- 가장 큰 이유는 세션 대신 토큰을 사용하기 위해서다.
    - 서버 여러 대가 동작하는 상황이라면, 각 서버마다 세션 저장소를 두거나 공통 세션 저장소를 만들어야 하는 비용이 든다.
    - 서버 여러 대가 동작하는 상황일 때, 토큰은 stateless 하기 때문에 확장에 용이하다.
    - 단, 토큰은 한 번 발급되면 강제로 삭제할 수 없기 때문에 만료 시간이 짧은 액세스 토큰과 만료 시간이 긴 리프레시 토큰을 나눠서 사용한다.
    - 클라이언트는 액세스 토큰을 저장해 두고 요청 때마다 보내는 방식이다.
    - 만약 액세스 토큰이 만료되지 않았다면 로그아웃 했더라도 토큰을 가지고 있다면 로그인된 상태처럼 접속할 수 있다.
<br/>
 
### Stateless

- 서버가 클라이언트의 상태를 보존하지 않는다.
- 서버는 클라이언트를 기억하지 않고 오직 클라이언트의 요청에 대한 응답만 준다.
- HTTP 통신은 서버를 무한 확장하는 데 용이한 Stateless 방식을 지향한다.
- 만약 서버가 Stateful 하면 서버 장애가 발생했을 때, 그 서버와 연결된 클라이언트가 기존 작업을 처음부터 다시 해야 한다.
- 만약 서버가 Stateless 하면 서버 장애가 발생했을 때, 클라이언트 쪽에서 고객의 정보를 보관하므로 한 서버에서 장애가 나도 다른 서버에서 얼마든지 이후 요청을 처리할 수 있다.
<br/>
 
### 서버 기반 인증 vs 토큰 기반 인증

- 서버 기반 인증
    - 인증에 필요한 정보를 모두 서버에 저장하고 클라이언트에서 요청이 왔을 때 응답한다.
- 토큰 기반 인증
    - 서버에 세션이 존재하지 않고 클라이언트 쪽에서 사용자의 로그인 상태를 관리하므로 어떤 서버로 요청이 들어가든 상관없다.
    - 프로세스
        1. 사용자가 회원 가입을 하면서 사용자 정보가 DB에 저장된다.
        2. 로그인 시, 아이디, 비밀번호를 서버로 보낸다.
        3. 서버가 아이디, 비밀번호를 DB 와 대조하여 인증이 되면 액세스 토큰을 생성하여 발급한다. 
        4. 클라이언트는 발급받은 토큰을 쿠키에 저장한다. 로컬 스토리지는 해킹 위험이 있어 잘 사용하지 않는다.
        5. 서버에 요청을 보낼 때마다 액세스 토큰을 헤더에 담아서 보낸다.
        6. 서버에서는 토큰의 유효기간과 토큰의 ‘서명’ 부분을 확인하여 인가한 뒤, 요청받은 클라이언트에게 보낸다.
<br/>
 
### JWT 구조

- 헤더.페이로드.서명 형식이다.
- 토큰의 맨 뒤에 붙는 서명을 통해 특정 사용자의 정보를 식별하게 된다.
- 헤더
    - type : 토큰의 타입을 지정한다.
    - alg : 해싱 알고리즘을 지정한다. 주로 HMAC SHA256 또는 RSA가 사용된다.
        - 토큰을 검증할 때 서명 부분에서 사용된다.
    
    ```json
    { 
    	"type": "JWT",
    	"alg": "HS256"
    }
    ```
    
- 페이로드
    - 토큰에 담을 정보가 들어 있다.
    - name/value 한 쌍을 클레임이라고 부른다.
    - 클레임 종류
        - registered : 서비스에서 필요한 정보들이 아닌 토큰에 대한 옵셔널한 정보
            - iss : 토큰 발급자
            - sub : 토큰 제목
            - aud : 토큰 대상자
            - exp : 토큰의 만료 시간
            - nbf : 토큰의 활성 날짜 (이 날짜가 지나기 전까진 토큰이 처리되지 않는다.)
            - iat : 토큰이 발급된 시간 (토큰의 나이를 알 수 있다.)
            - jti : JWT의 고유 식별자. 주로 중복적인 처리를 방지하기 위해 사용된다. 일회용 토큰에 사용하면 유용하다.
        - public : 공개 클레임은 충돌 방지를 위해 이름을 uri 형식으로 짓는다.
            
            ```json
            { 
            	"https://velopert.com/jwt_claims/is_admin": true
            }
            ```
            
        - private : 공개 클레임과는 달리 충돌 가능성이 있으므로 주의해야 한다.
        
        ```json
        {
        	"iss": "journi.com",
          "exp": "1485270000000000",
        	"https://journi.com/public-claim": true,
        	"userId": "11002",
        	"username" : "journi"
        }
        ```
        
- 서명 : 토큰을 인코딩하거나 유효성을 검증할 때 사용하는 고유한 암호 코드다.
<br/>
 
### 보안 전략

- JWT Access Token 만료 시간
    - 짧은 만료 시간 30분
        - 장점 : 기기나 액세스 토큰이 탈취 되더라도 빠르게 만료된다.
        - 단점 : 사용자는 자주 로그인 해야 한다.
    - 긴 만료 시간 2주~한달
        - 장점 : 사용자가 로그인을 자주 할 필요가 없다.
        - 단점 : 기기나 액세스 토큰이 탈취되면 오랫동안 제약 없이 사용이 가능하므로 보안에 취약하다.
- 슬라이딩 세션
    - 보안과 편의성 모두 잡기 위함
    - 세션을 지속적으로 이용하는 유저에게 자동으로 만료 기한을 늘려주는 방법
    - 장점 : 로그인 자주할 필요 없다. 글 작성, 결제 등 세션 유지가 필요한 순간에 세션이 만료되는 문제를 방지할 수 있다.
    - 단점 : 접속이 주로 단발성으로 이루어지는 경우 효과가 크지 않다. 긴 만료 시간을 갖는 액세스 토큰을 사용하는 경우 로그인 자체를 안 해도 되는 경우가 발생한다.
- JWT Refresh Token
    - 액세스 토큰과 함께 그에 비해 긴 만료시간을 갖는 리프레시 토큰을 함께 발급하는 방법이다.
    - 주로 액세스 토큰은 30분 내외, 리프레시 토큰은 2주에서 한달 정도의 만료 기간을 부여한다.
    - 액세스 토큰이 만료될 경우 따로 저장해두었던 리프레시 토큰을 이용하여 액세스 토큰의 재발급을 요청한다.
    - 서버는 유효한 리프레시 토큰이 들어오면 액세스 토큰을 발급하고, 만료된 리프레시 토큰이 들어오면 로그인하라고 응답한다.
    - 액세스 토큰은 서버에 따로 저장해 둘 필요 없지만, 리프레시 토큰은 서버의 스토리지에 따로 저장해서 이후 검증에 활용해야 한다.
        - 즉, 추가적인 DB I/O 작업이 필요하기 때문에 빠른 인증 처리를 장점으로 내세우는 JWT 스펙에 포함되지 않는 부가적인 방식이다.
        - 리프레시 토큰은 탈취되어서는안되므로 클라이언트는 보안이 유지되는 공간에 이를 저장해 두어야 한다.
        - 또한 리프레시 토큰은 서버에 따로 저장을 하고 있기 때문에 강제로 토큰을 만료시키는 것이 가능해진다.
    - 장점 :
        - 짧은 만료 기간을 사용할 수 있기 때문에 액세스 토큰이 탈취되더라도 제한된 기간만 접근이 가능하다.
        - 사용자가 로그인을 자주할 필요가 없다.
        - 리프레시 토큰에 대한 만료를 강제로 설정할 수 있다.
    - 단점 :
        - 클라이언트는 액세스 토큰의 만료에 대한 연장 요청을 구현해야 한다.
        - 인증 만료 기간의 자동 연장이 불가능하다.
        - 서버에 별도 스토리지를 만들어야 한다.
- 슬라이딩 세션 전략과 리프레시 토큰을 모두 사용
    - 리프레시 토큰의 만료 기간을 늘려준다.
    - 장점 :
        - 리프레시 토큰의 만료 기간에 대한 제약을 받지 않는다.
        - 글을 작성하거나 결제를 하는 등의 세션 유지가 필요한 순간에 세션이 만료되는 문제를 방지할 수 있다.
    - 단점 :
        - 서버에 강제로 리프레시 토큰을 만료하지 않는 한 지속적으로 사용이 간으하다.
        - 인증이 추가로 요구되는 경우에 대한 보안 강화가 필요하다.

<br/>
<br/>
<hr/>

### 참고 레퍼런스
- [https://velog.io/@yena1025/JWT-토큰과-무상태성Stateless](https://velog.io/@yena1025/JWT-%ED%86%A0%ED%81%B0%EA%B3%BC-%EB%AC%B4%EC%83%81%ED%83%9C%EC%84%B1Stateless)
- [https://seungwoolog.tistory.com/95](https://seungwoolog.tistory.com/95)
